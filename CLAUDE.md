# LinkFlyer Next - AI-Powered Event Profile Creator

## ğŸš¨ CRITICAL RULES - NEVER VIOLATE ğŸš¨
1. **äº‹å®Ÿã¨ç•°ãªã‚‹å ±å‘Šã¯çµ¶å¯¾ã«ã—ãªã„ - NEVER**
   - å®Ÿè¡Œã—ã¦ã„ãªã„ä½œæ¥­ã‚’ã€Œå®Œäº†ã—ãŸã€ã¨å ±å‘Šã—ãªã„
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã„ãªã„ã®ã«ã€Œå‰Šé™¤ã—ãŸã€ã¨è¨€ã‚ãªã„
   - å¸¸ã«æ­£ç¢ºãªçŠ¶æ³ã‚’å ±å‘Šã™ã‚‹

2. **å„Phaseå®Œäº†å¾Œã¯å¿…ãšREADME.mdæ›´æ–° - ALWAYS**
   - Phaseå®Œäº†æ™‚ã¯å³åº§ã«README.mdã®é€²æ—çŠ¶æ³ã‚’æ›´æ–°ã™ã‚‹
   - å®Œäº†é …ç›®ã‚’âœ…ã«å¤‰æ›´ã—ã€æ¬¡ã®Phaseã‚’ç¾åœ¨å®Ÿè¡Œä¸­ã«å¤‰æ›´ã™ã‚‹
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¨€ã‚ã‚Œã‚‹å‰ã«è‡ªå‹•çš„ã«æ›´æ–°ã™ã‚‹ã“ã¨

3. **ğŸ Safari Audioå†ç”Ÿã®å®Ÿè£…ã¯çµ¶å¯¾ã«ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„ - CRITICAL**
   - Safari browserç‰¹æœ‰ã®SoundCloud Widget APIã®åˆå›å†ç”Ÿãƒã‚¦ãƒ³ã‚¹å•é¡Œ
   - `initializeAndPlay`é–¢æ•°ã«ã‚ˆã‚‹åˆæœŸåŒ–å‡¦ç†ã¯å¿…é ˆå®Ÿè£…é …ç›®
   - ã“ã®å®Ÿè£…ãªã—ã§ã¯Safariã§éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ­£å¸¸å‹•ä½œã—ãªã„
   - Reactç‰ˆã‹ã‚‰Next.jsç‰ˆã¸ã®ç§»è¡Œæ™‚ã«å¿…ãšå«ã‚ã‚‹ã“ã¨

4. **Reactç‰ˆã«ãªã„è¨­å®šã‚’è¿½åŠ ã™ã‚‹éš›ã¯å¿…ãšäº‹å‰æ‰¿èªã‚’å¾—ã‚‹ - MANDATORY**
   - linkflyer_reactãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã€æ—¢å­˜ã®å®Ÿè£…ã‚’ç¢ºèªã™ã‚‹
   - Reactç‰ˆã«ãªã„æ–°ã—ã„CSSè¨­å®šã€JavaScriptæ©Ÿèƒ½ã€HTMLæ§‹é€ ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªã‚’å¾—ã‚‹
   - ç‰¹ã«ä»¥ä¸‹ã®å¤‰æ›´ã¯è¦æ³¨æ„ï¼š
     - ã‚°ãƒ­ãƒ¼ãƒãƒ«CSSï¼ˆhtml, bodyè¦ç´ ã¸ã®è¨­å®šï¼‰
     - overflowã€heightã€positionãªã©ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå½±éŸ¿è¨­å®š
     - iOS Safariç‰¹æœ‰ã®æŒ™å‹•ã«é–¢ã‚ã‚‹è¨­å®š
   - æ‰¿èªãªã—ã«è¿½åŠ ã—ãŸå ´åˆã¯å³åº§ã«å…ƒã«æˆ»ã™ã“ã¨

## Overview
LinkFlyer Nextã¯Reactç‰ˆã‹ã‚‰Next.js 14 App Routerã¸ã®ç§»è¡Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚SSR/SSGã®åˆ©ç‚¹ã‚’æ´»ã‹ã—ã¤ã¤ã€SoundCloud Widget APIã‚’ä½¿ç”¨ã—ãŸã‚°ãƒ­ãƒ¼ãƒãƒ«éŸ³æ¥½å†ç”Ÿæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨SEOã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚

## Tech Stack
- **Framework**: Next.js 14 with App Router
- **Language**: TypeScript (strict mode)
- **Styling**: Tailwind CSS with mobile-first responsive design
- **Database**: Supabase PostgreSQL with Row Level Security
- **Authentication**: Supabase Auth with Next.js middleware
- **AI/ML**: Google Gemini API for image analysis (äºˆå®š)
- **Geocoding**: Google Maps Places API (äºˆå®š)
- **Storage**: Supabase Storage with automatic cleanup
- **Audio Playback**: SoundCloud Widget API with Two Player Architecture + Global Player System
- **PWA**: Service Worker, Web App Manifest (äºˆå®š)
- **Deployment**: Vercel

## Project Structure
```
linkflyer_next/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ layout.tsx                      # Root layout with providers
â”‚       â”œâ”€â”€ page.tsx                        # Home redirect page
â”‚       â”œâ”€â”€ [username]/
â”‚       â”‚   â”œâ”€â”€ page.tsx                    # Dynamic user profile (Server Component)
â”‚       â”‚   â””â”€â”€ ProfileClient.tsx           # Profile UI (Client Component)
â”‚       â”œâ”€â”€ auth/
â”‚       â”‚   â””â”€â”€ page.tsx                    # Authentication page (æœªå®Ÿè£…)
â”‚       â”œâ”€â”€ admin/
â”‚       â”‚   â”œâ”€â”€ layout.tsx                  # Admin layout with protection (æœªå®Ÿè£…)
â”‚       â”‚   â”œâ”€â”€ page.tsx                    # Admin dashboard (æœªå®Ÿè£…)
â”‚       â”‚   â”œâ”€â”€ edit/page.tsx               # Profile editing (æœªå®Ÿè£…)
â”‚       â”‚   â”œâ”€â”€ social/page.tsx             # Social links management (æœªå®Ÿè£…)
â”‚       â”‚   â”œâ”€â”€ audio/page.tsx              # Audio management (æœªå®Ÿè£…)
â”‚       â”‚   â””â”€â”€ flyers/page.tsx             # Flyers management (æœªå®Ÿè£…)
â”‚       â”œâ”€â”€ flyers/
â”‚       â”‚   â””â”€â”€ [id]/page.tsx               # Flyer detail page (æœªå®Ÿè£…)
â”‚       â”œâ”€â”€ api/
â”‚       â”‚   â”œâ”€â”€ auth/[...supabase]/route.ts # Supabase auth handler (æœªå®Ÿè£…)
â”‚       â”‚   â””â”€â”€ soundcloud/route.ts         # SoundCloud API proxy (æœªå®Ÿè£…)
â”‚       â”œâ”€â”€ globals.css                     # Global styles
â”‚       â””â”€â”€ components/
â”‚           â”œâ”€â”€ SoundCloudPlayerV3SingleTwo.tsx  # Individual track player
â”‚           â”œâ”€â”€ GlobalMiniPlayer.tsx        # Persistent mini player
â”‚           â”œâ”€â”€ GlobalModal.tsx             # Full-screen modal
â”‚           â”œâ”€â”€ DebugInfo.tsx               # Debug information component
â”‚           â””â”€â”€ providers/
â”‚               â””â”€â”€ TwoPlayerProvider.tsx   # Global player state
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts                       # Client-side Supabase
â”‚   â”‚   â””â”€â”€ queries.ts                      # Database query functions
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ dataTransform.ts                # Data transformation utilities
â”œâ”€â”€ types/
â”‚   â””â”€â”€ database.ts                         # Database type definitions
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ icons/                              # Social media SVG icons
â”‚   â””â”€â”€ iori_asano-profile.jpg              # Profile image
â”œâ”€â”€ middleware.ts                           # Next.js middleware (æœªå®Ÿè£…)
â”œâ”€â”€ next.config.js                          # Next.js configuration
â”œâ”€â”€ tailwind.config.ts                      # Tailwind configuration
â”œâ”€â”€ tsconfig.json                           # TypeScript configuration
â””â”€â”€ .env.local                              # Environment variables
```

## Key Differences from React Version
1. **App Router**: Using Next.js 14 App Router instead of React Router
2. **Server Components**: Default RSC for better performance
3. **Client Components**: Strategic use with "use client" directive
4. **API Routes**: Built-in API handling for proxy endpoints
5. **Middleware**: Authentication protection at edge
6. **Image Optimization**: Next/Image for automatic optimization
7. **SEO**: Built-in metadata API for better SEO
8. **Streaming**: Progressive rendering with Suspense
9. **Environment Variables**: No prefix needed for server-side vars

## Migration Strategy

### Phase 0: Audioå®Ÿè£… + å‹•ä½œç¢ºèª âœ…
- [x] Next.js 14 project with App Router setup
- [x] Configure TypeScript and Tailwind CSS  
- [x] TwoPlayerProvider implementation (500+ lines)
- [x] SoundCloudPlayerV3SingleTwo (600+ lines)
- [x] GlobalMiniPlayer implementation
- [x] GlobalModal implementation  
- [x] DebugInfo development tools
- [x] Safariåˆå›å†ç”Ÿãƒã‚¦ãƒ³ã‚¹å•é¡Œã®è§£æ±º
- [x] Progress Barã‚·ãƒ¼ã‚¯æ©Ÿèƒ½å®Œå…¨å®Ÿè£…
- [x] Cross-page navigation testing
- [x] Touchæ“ä½œå®Œå…¨å¯¾å¿œ
- [x] Glass Morphismãƒ‡ã‚¶ã‚¤ãƒ³çµ±ä¸€

### Phase 1: Supabaseé€£æºã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒšãƒ¼ã‚¸å®Ÿè£… âœ…
- [x] Supabase client configuration
- [x] Database type definitions (Profile, Audio, Flyer)
- [x] Query functions (getProfileByUsername, getAudioTracksByUserId, getFlyersByUserId)
- [x] Data transformation utilities (SoundCloudTrack format)
- [x] Dynamic [username] routing implementation
- [x] ProfileClient component (Server/Client Components separation)
- [x] Audio tracks display with Supabase data
- [x] Flyers display withç¸¦é•·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ and ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æƒ…å ±
- [x] å†ç”Ÿä¸­ã‚¤ãƒ³ãƒ‡ã‚£ã‚±ãƒ¼ã‚¿ (éŸ³æ³¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³)
- [x] Home page redirect (/ â†’ /naof219)

### Phase 2: è¿½åŠ æ©Ÿèƒ½å®Ÿè£… (æœªç€æ‰‹)
- [ ] Admin dashboard pages
- [ ] Authentication page with Supabase Auth
- [ ] Flyer detail pages
- [ ] User profile editing functionality
- [ ] Audio/Flyer upload functionality

### Phase 3: API & Server Functions (æœªç€æ‰‹)
- [ ] SoundCloud oEmbed API proxy route
- [ ] Image upload API endpoints
- [ ] Authentication API routes
- [ ] Database query optimizations
- [ ] Edge function for auth checks

### Phase 4: Features & Optimization (æœªç€æ‰‹)
- [ ] PWA configuration
- [ ] Service Worker setup
- [ ] Image optimization with Next/Image
- [ ] SEO metadata implementation
- [ ] Performance monitoring

## Development Commands
```bash
# Development server
npm run dev

# Build for production
npm run build

# Start production server
npm start

# Type checking
npm run type-check

# Linting
npm run lint

# Format code
npm run format
```

## Environment Setup
Create `.env.local` file:
```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Google APIs
NEXT_PUBLIC_GOOGLE_API_KEY=your-google-api-key

# App URL
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

## Database Schema (Supabase)
Same as React version:
- **profiles**: User profile information
- **audio**: Audio tracks (renamed from 'links')
- **flyers**: Event flyers
- **storage buckets**: profile-images, flyer-images

### Row Level Security (RLS) Configuration
åŒã˜RLSè¨­å®šã‚’ä½¿ç”¨ï¼ˆReactç‰ˆã®CLAUDE.mdã‚’å‚ç…§ï¼‰

## Global Audio Player System in Next.js

### Architecture Adaptations
1. **Client-Only Components**: Audio players must be Client Components
2. **Provider Pattern**: TwoPlayerProvider wraps client components
3. **Hydration Safety**: Handle SSR/CSR differences carefully
4. **State Persistence**: Use localStorage for cross-page state

### Implementation Strategy
```typescript
// app/layout.tsx
import { TwoPlayerProvider } from '@/components/providers/TwoPlayerProvider'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <TwoPlayerProvider>
          {children}
          {/* Global player components */}
          <GlobalMiniPlayer />
          <GlobalModal />
        </TwoPlayerProvider>
      </body>
    </html>
  )
}
```

### Client Component Pattern
```typescript
// components/audio/SoundCloudPlayer.tsx
'use client'

import { useEffect, useState } from 'react'
import { useTwoPlayer } from '@/hooks/useTwoPlayer'

export default function SoundCloudPlayer({ url, title }: Props) {
  // Client-side only logic
}
```

## Server Components Best Practices

### Data Fetching
```typescript
// app/[username]/page.tsx
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'

export default async function UserProfile({ 
  params 
}: { 
  params: { username: string } 
}) {
  const supabase = createServerComponentClient()
  
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('username', params.username)
    .single()
    
  return <UserProfileClient profile={profile} />
}
```

### Streaming with Suspense
```typescript
// app/[username]/page.tsx
import { Suspense } from 'react'
import AudioGrid from '@/components/AudioGrid'
import AudioGridSkeleton from '@/components/AudioGridSkeleton'

export default function UserProfile() {
  return (
    <Suspense fallback={<AudioGridSkeleton />}>
      <AudioGrid />
    </Suspense>
  )
}
```

## Middleware for Authentication
```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })
  
  const { data: { session } } = await supabase.auth.getSession()
  
  // Protect admin routes
  if (req.nextUrl.pathname.startsWith('/admin')) {
    if (!session) {
      return NextResponse.redirect(new URL('/auth', req.url))
    }
  }
  
  return res
}

export const config = {
  matcher: ['/admin/:path*']
}
```

## API Routes Pattern
```typescript
// app/api/soundcloud/route.ts
import { NextRequest, NextResponse } from 'next/server'

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url)
  const url = searchParams.get('url')
  
  // Proxy to SoundCloud oEmbed API
  const response = await fetch(
    `https://soundcloud.com/oembed?url=${url}&format=json`
  )
  
  const data = await response.json()
  return NextResponse.json(data)
}
```

## Performance Optimizations

### Image Optimization
```typescript
import Image from 'next/image'

<Image
  src={track.image_url}
  alt={track.title}
  width={300}
  height={300}
  loading="lazy"
  placeholder="blur"
  blurDataURL={track.blur_data_url}
/>
```

### Dynamic Imports
```typescript
import dynamic from 'next/dynamic'

const SoundCloudPlayer = dynamic(
  () => import('@/components/audio/SoundCloudPlayer'),
  { 
    loading: () => <PlayerSkeleton />,
    ssr: false 
  }
)
```

### Prefetching
```typescript
import Link from 'next/link'

<Link href={`/${username}`} prefetch>
  View Profile
</Link>
```

## SEO & Metadata
```typescript
// app/[username]/page.tsx
export async function generateMetadata({ 
  params 
}: { 
  params: { username: string } 
}) {
  const profile = await getProfile(params.username)
  
  return {
    title: `${profile.display_name} | LinkFlyer`,
    description: profile.bio,
    openGraph: {
      images: [profile.profile_image],
    },
  }
}
```

## Development Rules
**IMPORTANT**: å•é¡Œåˆ†æãƒ»è§£æ±ºç­–ã®åˆæ„â†’å®Ÿè£…ã®é †åºã‚’å¿…ãšå®ˆã‚‹ã“ã¨
1. **å•é¡Œã®ç‰¹å®š**: ç¾åœ¨ã®å•é¡Œãƒ»èª²é¡Œã‚’æ˜ç¢ºã«ç‰¹å®šã™ã‚‹
2. **è§£æ±ºç­–ã®ææ¡ˆ**: è¤‡æ•°ã®è§£æ±ºæ¡ˆã‚’æç¤ºã—ã€æœ€é©ãªæ–¹æ³•ã‚’æ¤œè¨ã™ã‚‹  
3. **å®Ÿè£…æ–¹é‡ã®åˆæ„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å®Ÿè£…æ–¹é‡ã«ã¤ã„ã¦åˆæ„ã—ã¦ã‹ã‚‰å®Ÿè£…é–‹å§‹
4. **å®Ÿè£…å®Ÿè¡Œ**: åˆæ„ã•ã‚ŒãŸæ–¹é‡ã«å¾“ã£ã¦å®Ÿè£…ã‚’è¡Œã†

**ç¦æ­¢äº‹é …**: æ–¹é‡åˆæ„å‰ã®å®Ÿè£…é–‹å§‹ã¯å³ç¦ã€‚å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæ„ã‚’å¾—ã¦ã‹ã‚‰å®Ÿè£…ã™ã‚‹ã“ã¨ã€‚

## **ğŸš¨ CRITICAL: å®Œäº†å ±å‘Šã®èª å®Ÿæ€§ ğŸš¨**
**NEVER LIE ABOUT IMPLEMENTATION STATUS**

### çµ¶å¯¾çš„ãƒ«ãƒ¼ãƒ«ï¼š
- **å®Ÿè£…ãŒä¸å®Œå…¨ãªå ´åˆã¯æ­£ç›´ã«å ±å‘Šã—ã¾ã™**
- **æ©Ÿèƒ½ãŒç°¡ç•¥åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ˜ç¢ºã«èª¬æ˜ã—ã¾ã™**
- **å…ƒã®ä»•æ§˜ã¨ç•°ãªã‚‹å ´åˆã¯å·®åˆ†ã‚’è©³ç´°ã«å ±å‘Šã—ã¾ã™**
- **"å®Œäº†"ã¯100%å®Œå…¨å®Ÿè£…ã®å ´åˆã®ã¿ä½¿ç”¨ã—ã¾ã™**

### å ±å‘Šä¾‹ï¼š
âŒ **é–“é•ã„**: "å…¨ã¦ã®Audioã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…å®Œäº†"
âœ… **æ­£ã—ã„**: "Audioã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åŸºæœ¬æ©Ÿèƒ½ã¯å®Ÿè£…æ¸ˆã¿ã§ã™ãŒã€ä»¥ä¸‹ãŒæœªå®Œæˆã§ã™ï¼š
- éŸ³æ³¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæœªå®Ÿè£…ï¼‰
- ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œï¼ˆæœªå®Ÿè£…ï¼‰
- SoundCloudPlayerV3.cssï¼ˆ937è¡Œä¸­200è¡Œã®ã¿ç§»æ¤ï¼‰
- ã‚·ãƒ§ãƒƒãƒ—ãƒªãƒ³ã‚¯çµ±åˆï¼ˆéƒ¨åˆ†çš„å®Ÿè£…ï¼‰"

### å®Œäº†ã®å®šç¾©ï¼š
- å…ƒã®Reactç‰ˆã¨**100%åŒã˜æ©Ÿèƒ½**
- **100%åŒã˜è¦‹ãŸç›®**
- **100%åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**

ã“ã®åŸºæº–ã«æº€ãŸãªã„å ´åˆã¯ã€Œå®Ÿè£…ä¸­ã€ã€Œéƒ¨åˆ†çš„å®Œæˆã€ã€ŒåŸºæœ¬æ©Ÿèƒ½å®Œæˆã€ç­‰ã®æ­£ç¢ºãªè¡¨ç¾ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

## Mobile-First Design Principles
- Touch targets minimum 44px
- No hover-only interactions
- Optimized for mobile gestures
- Fast loading on mobile networks
- Responsive breakpoints: 375px, 480px, 768px, 1024px
- Glass morphism effects for modern UI
- Gradient overlays for text readability
- Sound wave animations for visual feedback

## Key Technical Decisions

### Why Next.js App Router?
- **Server Components**: Better performance with zero client JS
- **Streaming**: Progressive page loading
- **SEO**: Built-in optimization for search engines
- **Edge Runtime**: Faster response times globally

### Why Keep SoundCloud Widget API?
- **Proven Solution**: Already working in React version
- **Direct Integration**: Native SoundCloud features
- **Cross-Page Persistence**: Maintains playback state

### Why Supabase?
- **Existing Data**: Reuse current database
- **RLS**: Row-level security already configured
- **Real-time**: Future real-time features
- **Storage**: Integrated file storage

## Testing Strategy
- Unit tests for utilities and hooks
- Integration tests for API routes
- E2E tests for critical user flows
- Visual regression tests for UI components

## Deployment Strategy
1. **Development**: Local development with hot reload
2. **Preview**: Vercel preview deployments for PRs
3. **Staging**: Protected staging environment
4. **Production**: Vercel production with monitoring

## Performance Metrics
- **LCP**: < 2.5s (Largest Contentful Paint)
- **FID**: < 100ms (First Input Delay)
- **CLS**: < 0.1 (Cumulative Layout Shift)
- **TTI**: < 3.8s (Time to Interactive)

## Security Considerations
- Environment variables validation
- CORS configuration for API routes
- CSP headers for XSS protection
- Rate limiting on API endpoints
- Input sanitization
- SQL injection prevention via Supabase

## ğŸ Safari Audio Playback - CRITICAL IMPLEMENTATION

### å¿…é ˆå®Ÿè£…: Safariåˆå›å†ç”Ÿãƒã‚¦ãƒ³ã‚¹å•é¡Œã®å¯¾å¿œ
Safariãƒ–ãƒ©ã‚¦ã‚¶ã¯SoundCloud Widget APIã®åˆå›å†ç”Ÿæ™‚ã«ç‰¹æ®Šãªå‹•ä½œã‚’ç¤ºã—ã¾ã™ã€‚Widget ãŒå®Œå…¨ã«åˆæœŸåŒ–ã•ã‚Œã‚‹å‰ã«`play()`ã‚’å‘¼ã¶ã¨ã€ä¸€ç¬å†ç”Ÿã—ã¦ã™ãåœæ­¢ã™ã‚‹ã€Œbounceã€ç¾è±¡ãŒç™ºç”Ÿã—ã¾ã™ã€‚

### å¿…é ˆå®Ÿè£…è¦ç´ ï¼ˆçµ¶å¯¾ã«ã‚¹ã‚­ãƒƒãƒ—ç¦æ­¢ï¼‰

#### 1. çŠ¶æ…‹ç®¡ç†ã®è¿½åŠ 
```typescript
const [isInitialized, setIsInitialized] = useState(false)
const initClickedRef = useRef(false)
```

#### 2. Safariå°‚ç”¨åˆæœŸåŒ–é–¢æ•°
```typescript
const initializeAndPlay = useCallback(() => {
  if (!playerRef.current?.widget || !isReady || initClickedRef.current) return
  
  console.log('Initializing and playing...')
  initClickedRef.current = true
  
  // Safariå¯¾å¿œ: seekTo(0)ã‚’å‘¼ã‚“ã§ã‹ã‚‰å†ç”Ÿ
  playerRef.current.widget.seekTo(0)
  
  setTimeout(() => {
    playerRef.current.widget.play()
    
    // ã•ã‚‰ã«å°‘ã—å¾…ã£ã¦ã‹ã‚‰çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    setTimeout(() => {
      playerRef.current.widget.isPaused((paused: boolean) => {
        if (paused) {
          // ã¾ã ä¸€æ™‚åœæ­¢ä¸­ãªã‚‰ã€ã‚‚ã†ä¸€åº¦è©¦ã™
          playerRef.current.widget.play()
        }
      })
    }, 300)
  }, 100)
}, [isReady])
```

#### 3. togglePlayé–¢æ•°ã®åˆå›å‡¦ç†
```typescript
// åˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ç‰¹åˆ¥å‡¦ç†
if (!isInitialized && !initClickedRef.current) {
  initializeAndPlay()
  return
}
```

#### 4. çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆå‡¦ç†
- æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆæ™‚: `setIsInitialized(false)`, `initClickedRef.current = false`
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤æ™‚: åŒæ§˜ã«ãƒªã‚»ãƒƒãƒˆ
- PLAY ã‚¤ãƒ™ãƒ³ãƒˆæ™‚: `setIsInitialized(true)`

### å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [x] `initClickedRef` ã®è¿½åŠ 
- [x] `isInitialized` ã‚¹ãƒ†ãƒ¼ãƒˆã®è¿½åŠ 
- [x] `initializeAndPlay` é–¢æ•°ã®å®Ÿè£…
- [x] `togglePlay` ã§ã®åˆå›å‡¦ç†åˆ†å²
- [x] æ–°è¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆæ™‚ã®ãƒªã‚»ãƒƒãƒˆ
- [x] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤æ™‚ã®ãƒªã‚»ãƒƒãƒˆ
- [x] PLAY ã‚¤ãƒ™ãƒ³ãƒˆã§ã®åˆæœŸåŒ–å®Œäº†ãƒãƒ¼ã‚¯

âš ï¸ **è­¦å‘Š**: ã“ã®å®Ÿè£…ãªã—ã§ã¯Safariãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéŸ³æ¥½ã‚’æ­£å¸¸ã«å†ç”Ÿã§ãã¾ã›ã‚“ã€‚Reactç‰ˆã‹ã‚‰Next.jsç‰ˆã¸ã®ç§»è¡Œæ™‚ã«å¿…ãšå«ã‚ã‚‹ã“ã¨ã€‚

## Monitoring & Analytics
- Vercel Analytics for performance
- Sentry for error tracking
- Custom events for user interactions
- Database query performance monitoring

## Future Enhancements
- [ ] AI-powered flyer analysis with Gemini
- [ ] Automated event extraction from images
- [ ] Social media integration
- [ ] Analytics dashboard
- [ ] Multi-language support
- [ ] Dark mode
- [ ] Offline support with Service Worker

## ğŸ¯ Phase 0 å®Œäº†: Audioå®Ÿè£… + å‹•ä½œç¢ºèª
**å®Ÿè£…å®Œäº†æ—¥**: 2025-08-07  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†æ¸ˆã¿
**æœ€çµ‚æ›´æ–°æ—¥**: 2025-08-10

### ä¸»è¦å®Ÿè£…æˆæœ
1. **Safari Audioäº’æ›æ€§**: åˆå›å†ç”Ÿãƒã‚¦ãƒ³ã‚¹å•é¡Œã®å®Œå…¨è§£æ±º
2. **Two Player Architecture**: Reactç‰ˆã‹ã‚‰ã®å®Œå…¨ç§»æ¤
3. **Global/LocalçŠ¶æ…‹ç®¡ç†**: é‡è¤‡æ›´æ–°å•é¡Œã®è§£æ±º
4. **Progressive Enhancement**: SSR/CSRå¢ƒç•Œã®é©åˆ‡ãªå‡¦ç†
5. **Glass Morphism UI**: ç¾ä»£çš„ã§çµ±ä¸€ã•ã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³
6. **å®Œå…¨ãªãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ**: ã‚¿ãƒƒãƒæ“ä½œã®å®Œå…¨å®Ÿè£…
7. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: ç„¡é§„ãªAPIå‘¼ã³å‡ºã—å‰Šé™¤
8. **ãƒ‡ãƒãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ **: åŒ…æ‹¬çš„ãªçŠ¶æ…‹ç›£è¦–æ©Ÿèƒ½

### æŠ€è¡“çš„ãªä¸»è¦è§£æ±ºé …ç›®
- **Safariåˆå›å†ç”Ÿãƒã‚¦ãƒ³ã‚¹**: `initializeAndPlay`ã«ã‚ˆã‚‹ç¢ºå®ŸãªåˆæœŸåŒ–
- **Progress Barä¸å…·åˆ**: ã‚°ãƒ­ãƒ¼ãƒãƒ«/ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã®å®Œå…¨åˆ†é›¢
- **PLAY_PROGRESSé‡è¤‡**: æ¡ä»¶åˆ†å²ã«ã‚ˆã‚‹é©åˆ‡ãªæ›´æ–°åˆ¶å¾¡
- **ãƒ¢ãƒã‚¤ãƒ«æ“ä½œ**: Touch eventsã®å®Œå…¨å¯¾å¿œ
- **React Hooks Rules**: å…¨ãƒ«ãƒ¼ãƒ«æº–æ‹ ã«ã‚ˆã‚‹å®‰å®šæ€§å‘ä¸Š
- **Z-indexç®¡ç†**: éšå±¤åŒ–UIè¦ç´ ã®é©åˆ‡ãªé…ç½®

### Reactç‰ˆã‹ã‚‰ã®æ”¹å–„ç‚¹
- **TypeScriptå‹å®‰å…¨æ€§**: ã‚ˆã‚Šå³å¯†ãªå‹ãƒã‚§ãƒƒã‚¯
- **Next.jsæœ€é©åŒ–**: Server/Client Componentsã®é©åˆ‡ãªåˆ†é›¢
- **UIçµ±ä¸€æ€§**: Glass morphismã«ã‚ˆã‚‹ä¸€è²«ã—ãŸãƒ‡ã‚¶ã‚¤ãƒ³
- **é–‹ç™ºä½“é¨“**: åŒ…æ‹¬çš„ãªãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: Position pollingæœ€é©åŒ–
- **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: ã‚ˆã‚Šè‰¯ã„ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰/ã‚¿ãƒƒãƒå¯¾å¿œ

## ğŸ“ 2025-08-10 è¿½åŠ ä¿®æ­£å†…å®¹

### 1. Global Mini Playerè¡¨ç¤ºå•é¡Œã®ä¿®æ­£
- **å•é¡Œ**: ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®åˆæœŸè¡¨ç¤ºä¸å…·åˆã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®æ²ˆã¿è¾¼ã¿
- **åŸå› **: CSSè¨­å®šã®ä¸å®Œå…¨ãªç§»æ¤
- **è§£æ±ºç­–**: 
  - Reactç‰ˆã®`soundcloud-miniplayer-v3`ã‚¯ãƒ©ã‚¹ã‚’`.global-mini-player-fixed`ã¨ã—ã¦å®Œå…¨ç§»æ¤
  - `position: fixed !important`ãªã©ã€å…¨ã¦ã®é‡è¦ãªè¨­å®šã‚’é©ç”¨
  - GPU accelerationã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–ã‚’è¿½åŠ 

### 2. iOS Safari URLãƒãƒ¼å•é¡Œã®è§£æ±º
- **å•é¡Œ**: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«URLãƒãƒ¼ãŒè‡ªå‹•éè¡¨ç¤ºã«ãªã‚‰ãªã„
- **åŸå› **: Reactç‰ˆã«ãªã„`height: 100%`ã¨`overflow-x: hidden`ã‚’è¿½åŠ ã—ã¦ã„ãŸ
- **è§£æ±ºç­–**: Reactç‰ˆã¨åŒã˜ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­å®šã«æˆ»ã™ï¼ˆbodyã®`margin: 0`ã®ã¿ï¼‰

### 3. Debug Infoä½ç½®èª¿æ•´
- **å•é¡Œ**: Debug InfoãŒModalã®æ“ä½œã‚’å¦¨ã’ã¦ã„ãŸ
- **è§£æ±ºç­–**: 50pxä¸Šã«ç§»å‹•ï¼ˆtop: 70px â†’ 20pxï¼‰

### 4. é–‹ç™ºãƒ«ãƒ¼ãƒ«ã®è¿½åŠ 
- **æ–°ãƒ«ãƒ¼ãƒ«**: Reactç‰ˆã«ãªã„è¨­å®šã‚’è¿½åŠ ã™ã‚‹éš›ã¯å¿…ãšäº‹å‰æ‰¿èªã‚’å¾—ã‚‹ï¼ˆCRITICAL RULES #4ï¼‰

## ğŸ–¼ï¸ Flyer Modal System - Multi-Modalç®¡ç†

### Flyer Modalå®Ÿè£… (2025-08-10)
ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒšãƒ¼ã‚¸ã®ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½ã¨ã—ã¦ã€ç‹¬ç«‹ã—ãŸFlyer Modalã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

#### ä¸»è¦æ©Ÿèƒ½
1. **ç‹¬ç«‹ã—ãŸModalç®¡ç†**
   - Audioç³»Modalï¼ˆGlobal/Local Modalï¼‰ã¨ã¯å®Œå…¨åˆ†é›¢
   - å°‚ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: `FlyerModal.tsx`
   - ProfileClientå†…ã§çŠ¶æ…‹ç®¡ç†

2. **Modalç«¶åˆåˆ¶å¾¡**
   - Global Modalè¡¨ç¤ºæ™‚ â†’ Flyer Modalè‡ªå‹•ã§é–‰ã˜ã‚‹
   - è¤‡æ•°modalã®åŒæ™‚è¡¨ç¤ºã‚’é˜²æ­¢
   - Two Player Architectureã®æ—¢å­˜åˆ¶å¾¡ã¨çµ±ä¸€

3. **UIãƒ‡ã‚¶ã‚¤ãƒ³**
   - Audio Local Modalã¨çµ±ä¸€ã•ã‚ŒãŸClose buttonãƒ‡ã‚¶ã‚¤ãƒ³
   - ç™½ã„è§’ä¸¸ã‚³ãƒ³ãƒ†ãƒŠã€èƒŒæ™¯ã¼ã‹ã—åŠ¹æœ
   - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã€ESCã‚­ãƒ¼/èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯å¯¾å¿œ

4. **ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼æƒ…å ±è¡¨ç¤º**
   - å¤§ããªãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ç”»åƒè¡¨ç¤º
   - ã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜æ–‡
   - ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ä»˜ï¼ˆè‹±èªå½¢å¼ã€æ¼¢å­—ãªã—ï¼‰
   - ä¼šå ´åã€ä½æ‰€ï¼ˆçµµæ–‡å­—ãªã—ã€ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤ºï¼‰

#### æŠ€è¡“å®Ÿè£…
```typescript
// ProfileClient.tsxå†…ã§ã®åˆ¶å¾¡
const { globalModalVisible } = useTwoPlayer()

// Global ModalãŒé–‹ã„ãŸã¨ãã«Flyer Modalã‚’é–‰ã˜ã‚‹
useEffect(() => {
  if (globalModalVisible && isFlyerModalOpen) {
    console.log('Closing flyer modal because global modal opened')
    setIsFlyerModalOpen(false)
    setSelectedFlyer(null)
  }
}, [globalModalVisible, isFlyerModalOpen])
```

#### Modaléšå±¤ç®¡ç†
- **æœ€å„ªå…ˆ**: Global Modal (z-index: æœ€é«˜)
- **æ¬¡å„ªå…ˆ**: Local Modal (Audioç”¨)
- **ãã®ä»–**: Flyer Modal (Global Modalã«ã‚ˆã‚Šåˆ¶å¾¡ã•ã‚Œã‚‹)

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æãªã†ã“ã¨ãªãã€è¤‡æ•°ã®modalãŒé©åˆ‡ã«ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚

## Notes
- **Phase 0ãƒ»1å®Œäº†**: éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  + Supabaseãƒ‡ãƒ¼ã‚¿é€£æº + ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒšãƒ¼ã‚¸å®Ÿè£…å®Œäº†
- Reactç‰ˆã¨100%åŒç­‰ã®éŸ³æ¥½å†ç”Ÿæ©Ÿèƒ½ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å®Ÿç¾
- Safariå«ã‚€å…¨ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‹•ä½œç¢ºèªæ¸ˆã¿
- **å®Œå…¨å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½**:
  - SoundCloud Widget APIã«ã‚ˆã‚‹éŸ³æ¥½å†ç”Ÿï¼ˆTwo Player Architectureï¼‰
  - Supabaseã‹ã‚‰ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ»ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
  - å‹•çš„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆ/[username]ï¼‰ã«ã‚ˆã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒšãƒ¼ã‚¸
  - ç¸¦é•·ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æƒ…å ±
  - å†ç”Ÿä¸­ãƒˆãƒ©ãƒƒã‚¯ã®éŸ³æ³¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ãƒ‡ã‚£ã‚±ãƒ¼ã‚¿
  - Flyer Modalã‚·ã‚¹ãƒ†ãƒ ï¼ˆAudio Modalã¨ç‹¬ç«‹ç®¡ç†ã€ç«¶åˆåˆ¶å¾¡ï¼‰
- **Phase 2ä»¥é™ã¯æœªç€æ‰‹**: ç®¡ç†ç”»é¢ã€èªè¨¼ã€è©³ç´°ãƒšãƒ¼ã‚¸ãªã©ã®è¿½åŠ æ©Ÿèƒ½